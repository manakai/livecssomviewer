<!DOCTYPE html>
<html lang="en">
<head>
<title>Live CSSOM Viewer</title>
<link rel=author href="http://suika.fam.cx/~wakaba/who?">
<link rel=license href="http://suika.fam.cx/c/gnu/gpl">
<style type="text/css">
  #source-code, #parsed-tree, #parsed-code, #style-frame, #html-source-code,
  #log {
    display: block;
    width: 96%;
    min-height: 7em; _height: 7em;
    margin: 0;
    border: 1px black solid;
    padding: 0.4em;
  }
  #log {
    min-height: 2em; _height: 2em;
    max-height: 7em;
    overflow: auto;
  }
  h2 {
    margin: 1em 0 0 0;
    font-size: 70%;
  }
  h2:after {
    content: ":";
  }
  p, pre {
    margin: 0;
    text-indent: 0;
  }
  li {
    list-style-type: none;
  }
  ol ol {
    margin-left: 1em;
    padding-left: 0;
  }
  .IE-PAGES, .IE-IMPORTS {
    border-bottom: 1px gray dashed;
  }
/*
  iframe {
    width: 0;
    height: 0;
    margin: 0;
    border-style: none;
    padding: 0;
  }
*/
  pre {
    white-space: -moz-pre-wrap;
    white-space: pre-wrap;
  }
  
  .Interface {
    color: orangered;
  }
  .CSS-AT {
    color: blue;
  }
  .Selectors {
    font-weight: bolder;
  }
  .charset { }
  .URI { }
  .URI:before { content: "<" }
  .URI:after { content: ">" }
  .MQ { }
  .CSS-Property-Name {
    color: #800080;
  }
  .CSS-Property-Value { }
  .CSS-Property-Priority {
    color: #8000ff;
  }
</style>
<script type="text/javascript">
  function $(id) {
    return document.getElementById (id);
  }

  function htescape (s) {
    return s.replace (/&/, '&amp;')
        .replace (/</, '&lt;')
        .replace (/>/, '&gt;')
        .replace (/"/, '&quot;');
  } // s
  
  var updateTimer = 0;
  var prevSourceText = null;
  var prevHTMLSourceText = null;
  var parseMode = 'noQuirks';
  var prevParseMode = '';
  function sourceTextUpdated (forceUpdate) {
    if (updateTimer) {
      clearTimeout (updateTimer);
    }
    if (forceUpdate) {
      prevSourceText = null;
    }
    updateTimer = setTimeout (updateParsedTreeAndText, 100);
  } // sourceTextUpdated
  
  function updateParsedTreeAndText () {
    var newValue = $('source-code').value + '';
          /* Workaround for <http://suika.fam.cx/gate/2005/sw/cssText#anchor-2> */
    var newHTMLValue = $('html-source-code').value;
    if (prevSourceText != newValue || prevHTMLSourceText != newHTMLValue) {
      prevSourceText = newValue;
      prevHTMLSourceText = newHTMLValue;
      window.updateParsed (newValue, newHTMLValue);

      $('permalink').href = location.pathname + '?c=' +
          encodeURIComponent (newValue) + ';h=' +
          encodeURIComponent (newHTMLValue) + ';p=' +
          (parseMode == 'noQuirks' ? 'n' :
              parseMode == 'limitedQuirks' ? 'l' : 'q') +
          ';x=' + $('parse-context').value;
    }
  } // updateParsedTreeAndText

  window.onload = function () {
    var currentHTMLDoctype = '';
    if (document.styleSheets[0].rules && document.styleSheets[0].cssText) {
      var pre = $('parsed-code-parent').appendChild
          (document.createElement ('pre'));
      var code = pre.appendChild
          (document.createElement ('code'));
      code.id = 'parsed-code';

      window.updateParsed = function (sourceCodeValue, htmlSourceCodeValue) {
        var pcontext = $('parse-context').value;

        var iframe = $('style-frame');
        iframe.onreadystatechange = function () {
          if (this.readyState == 'complete') {
            var idoc = this.contentWindow.document;

            $('log').innerHTML = '';
            this.contentWindow.w = function (s) {
              record (s);
            };
            
            var idiv = idoc.body.firstChild;
            var ol = $('parsed-tree');
            ol.innerHTML = '';
            var code = $('parsed-code');

            if (pcontext == 'style-attribute') {
              window.addIEStyleDeclarationObjectToList (idiv.style, ol);
              code.innerText = idiv.style.cssText;
            } else {
              var istyle = idoc.getElementsByTagName ('style')[0];
              istyle.styleSheet.cssText = sourceCodeValue;
              window.addIEStyleSheetObjectToList (istyle.styleSheet, ol, true);
              code.innerText = istyle.styleSheet.cssText;
            }
            
            $('cssTreeLink').href = 'data:text/plain;charset=utf-8,' +
                encodeURIComponent ('<ol>' + ol.innerHTML + '</ol>');
            $('cssTextLink').href = 'data:text/plain;charset=utf-8,' +
                encodeURIComponent ($('parsed-code-parent').innerHTML);

            idiv.innerHTML = htmlSourceCodeValue;
 
            var htmlAll = encodeURIComponent (currentHTMLDoctype + '<html>' +
                idoc.documentElement.innerHTML + '</html>');
            $('test-as-data').href = 'data:text/html;charset=utf-8,' + htmlAll;
            $('test-as-about').href = 'about:' + htmlAll;
            $('test-as-javascript').href = 'javascript:%22' +
                htmlAll.replace (/%5C/g, '%5C%5C')
                    .replace (/%0D/g, '%5Cu000D')
                    .replace (/%0A/g, '%5Cu000A')
                    .replace (/%22/g, '%5C%22') + '%22';
            /*
              Note that these URI might not be equal to the one rendered,
              since |innerHTML| might not be return a round-tripable
              serialization of the DOM.  Especially, it cannot handle
              the case with |</style>| contained in |style| element.
              In addition, WinIE normalize |style| content.
            */

            this.onreadystatechange = null;
          }
        };
        var text = '<style></style><body><div';
        if (pcontext == 'style-attribute') {
          text += ' style="' + htescape (sourceCodeValue) + '"';
          /* NOTE: Or, you can set idiv.style.cssText */
        }
        text += '></div></body>';
        if (parseMode == 'noQuirks') {
          text = (currentHTMLDoctype = '<!DOCTYPE HTML>') + text;
        } else if (parseMode == 'limitedQuirks') {
          text = (currentHTMLDoctype = '<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">') +
              text;
        } else {
          currentHTMLDoctype = '';
        }
        iframe.src = 'javascript:\''+text+'\'';
      }; // updateParsed (IE)
    } else {
      var ol = $('parsed-code-parent').appendChild
          (document.createElement ('ol'));
      ol.id = 'parsed-code';
      $('show-all-props-all').style.display = 'none';
      
      window.updateParsed = function (sourceCodeValue, htmlSourceCodeValue) {
        var iframe = $('style-frame');
        var idoc = iframe.contentDocument;
        if (prevParseMode != parseMode) {
          if (parseMode == 'noQuirks') {
            idoc.write (currentHTMLDoctype = '<!DOCTYPE HTML>');
          } else if (parseMode == 'limitedQuirks') {
            idoc.write (currentHTMLDoctype = '<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">');
          } else {
            currentHTMLDoctype = '';
          }
          idoc.write ('<html><head><style></style></head>');
          idoc.write ('<body><div></div></body></html>');
          idoc.close ();
          prevParseMode = parseMode;

          iframe.contentWindow.w = function (s) {
            record (s);
          };
        }
        $('log').innerHTML = '';

        var pcontext = $('parse-context').value;

        var idiv = idoc.body.firstChild;

        var ol = $('parsed-tree');
        ol.innerHTML = '';

        var ol2 = $('parsed-code');
        ol2.textContent = '';

        if (pcontext == 'style-attribute') {
          idiv.setAttribute ('style', sourceCodeValue);

          window.addCSSOMStyleDeclarationObjectToList (idiv.style, ol);

          ol2.appendChild (document.createElement ('li'))
              .appendChild (document.createElement ('pre'))
              .appendChild (document.createElement ('code'))
              .textContent = idiv.style.cssText;
        } else {
          var istyle = idoc.getElementsByTagName ('style')[0];
          istyle.textContent = sourceCodeValue;

          addCSSOMStyleSheetObjectToList (istyle.sheet, ol);

          var rules = istyle.sheet.cssRules;
          for (var i = 0; i < rules.length; i++) {
            ol2.appendChild (document.createElement ('li'))
                .appendChild (document.createElement ('pre'))
                .appendChild (document.createElement ('code'))
                .textContent = rules[i].cssText;
          }
        }
            
        $('cssTreeLink').href = 'data:text/plain;charset=utf-8,' +
            encodeURIComponent ('<ol>' + ol.innerHTML + '</ol>');
  
        $('cssTextLink').href = 'data:text/plain;charset=utf-8,' +
            encodeURIComponent ('<ol>' + ol2.innerHTML + '</ol>');
          /* Firefox 1.5 does not allow to access to cssRules (!) if
             it contains an @import that is not loaded yet. */

        idiv.innerHTML = htmlSourceCodeValue;

        var htmlAll = encodeURIComponent (currentHTMLDoctype + '<html>' +
            idoc.documentElement.innerHTML + '</html>');
        $('test-as-data').href = 'data:text/html;charset=utf-8,' + htmlAll;
        $('test-as-about').href = 'about:' + htmlAll;
        $('test-as-javascript').href = 'javascript:%22' +
            htmlAll.replace (/%5C/g, '%5C%5C')
                .replace (/%0D/g, '%5Cu000D')
                .replace (/%0A/g, '%5Cu000A')
                .replace (/%22/g, '%5C%22') + '%22';
        /*
          Note that these URI might not be equal to the one rendered,
          since |innerHTML| might not be return a round-tripable serialization
          of the DOM.  Especially, it cannot handle the case with
          |</style>| contained in |style| element.
        */
      }; // updateParsed (CSSOM)
    }

    var q = location.search;
    if (q != null) {
      q = q.substring (1).split (/;/);
      for (var i = 0; i < q.length; i++) {
        var v = q[i].split (/=/, 2);
        v[0] = decodeURIComponent (v[0]);
        v[1] = decodeURIComponent (v[1] || '');
        if (v[0] == 'c') {
          $('source-code').value = v[1];
        } else if (v[0] == 'h') {
          $('html-source-code').value = v[1];
        } else if (v[0] == 'p') {
          if (v[1] == 'n') {
            $('compatMode-no-quirks').checked = true;
            parseMode = 'noQuirks';
          } else if (v[1] == 'l') {
            $('compatMode-limited-quirks').checked = true;
            parseMode = 'limitedQuirks';
          } else {
            $('compatMode-quirks').checked = true;
            parseMode = 'quirks';
          }
        } else if (v[0] == 'x') {
          $('parse-context').value = v[1];
        }
      }
    }

    sourceTextUpdated (true);
  }; // window.onload
  
  function addCSSOMStyleSheetObjectToList (obj, rList) {
    var li = document.createElement ('li');
    li.innerHTML = '<code class="Interface">StyleSheet</code>';
    rList.appendChild (li);
    var rules = obj.cssRules;
    if (rules && rules.length > 0) {
      var ol = document.createElement ('ol');
      li.appendChild (ol);
      for (var i = 0; i < rules.length; i++) {
        window.addCSSOMRuleObjectToList (rules[i], ol);
      }
    }
  } // addCSSOMStyleSheetObjectToList
  
  function addIEStyleSheetObjectToList (obj, rList, isRoot) {
    var li = document.createElement ('li');
    li.innerHTML = '<code class="Interface">StyleSheet</code>';
    if (isRoot) {
      var imports = obj.imports;
      if (imports && imports.length > 0) {
        var ol = document.createElement ('ol');
        ol.className = 'IE-IMPORTS';
        li.appendChild (ol);
        for (var i = 0; i < imports.length; i++) {
          window.addIEStyleSheetObjectToList (imports[i], ol, false);
        }
      }
      var pages = obj.pages;
      if (pages && pages.length > 0) {
        var ol = document.createElement ('ol');
        ol.className = 'IE-PAGES';
        li.appendChild (ol);
        for (var i = 0; i < pages.length; i++) {
          window.addIEPageObjectToList (pages[i], ol);
        }
      }
      var rules = obj.rules;
      if (rules && rules.length > 0) {
        var ol = document.createElement ('ol');
        li.appendChild (ol);
        for (var i = 0; i < rules.length; i++) {
          window.addIERuleObjectToList (rules[i], ol);
        }
      }
    } else {
      li.appendChild (document.createTextNode (' '));
      var uriCode = li.appendChild (document.createElement ('code'));
      uriCode.innerText = obj.href;
      uriCode.className = 'URI';
    }
    
    rList.appendChild (li);
  } // addIEStyleSheetObjectToList
  
  function addIEPageObjectToList (obj, rList) {
    var li = document.createElement ('li');
    li.innerHTML = '<code class="CSS-AT">@page</code> <code class="Selectors"></code>';
    li.lastChild.innerText = obj.selector + ':' + obj.pseudoClass;
    rList.appendChild (li);
  } // addIEPageObjectToList
  
  function addIERuleObjectToList (obj, rList) {
    var li = document.createElement ('li');
    li.innerHTML = '<code class="Selectors"></code>';
    li.lastChild.innerText = obj.selectorText;
    
    var ol = document.createElement ('ol');
    window.addIEStyleDeclarationObjectToList (obj.style, ol);
    li.appendChild (ol);
    
    rList.appendChild (li);
  } // addIERuleObjectToList
  
  function addCSSOMRuleObjectToList (obj, rList) {
    var li = document.createElement ('li');
    li.className = 'type' + obj.type;
    if (obj.type == 1 || obj.type == 5 || obj.type == 6) {
      if (obj.type == 1) {
        li.innerHTML = '<code class="Selectors"></code>';
        li.lastChild.textContent = obj.selectorText;
      } else if (obj.type == 5) {
        li.innerHTML = '<code class="CSS-AT">@font-face</code>';
      } else {
        li.innerHTML = '<code class="CSS-AT">@page</code> <code class="Selectors"></code>';
        li.lastChild.textContent = obj.selectorText;
      }
    } else if (obj.type == 2) {
      li.innerHTML = '<code class="CSS-AT">@charset</code> <code class="charset"></code>';
      li.lastChild.textContent = obj.encoding;
    } else if (obj.type == 3) {
      li.innerHTML = '<code class="CSS-AT">@import</code> <code class="URI"></code> <code class="MQ"></code>';
      li.lastChild.previousSibling.previousSibling.textContent = obj.href;
      li.lastChild.textContent = obj.media.mediaText;
    } else if (obj.type == 4) {
      li.innerHTML = '<code class="CSS-AT">@media</code> <code class="MQ"></code>';
      li.lastChild.textContent = obj.media.mediaText;
    } else {
      li.appendChild (document.createElement ('code')).textContent = obj.type;
      li.appendChild (document.createTextNode (': '));
      li.appendChild (document.createElement ('code')).textContent = obj.cssText;
    }
    rList.appendChild (li);
    
    var rules = obj.cssRules;
    if (rules && rules.length > 0) {
      var ol = document.createElement ('ol');
      li.appendChild (ol);
      for (var i = 0; i < rules.length; i++) {
        window.addCSSOMRuleObjectToList (rules[i], ol);
      }
    }
    
    var objstyle = obj.style;
    if (objstyle) {
      var ol = document.createElement ('ol');
      window.addCSSOMStyleDeclarationObjectToList (objstyle, ol);
      li.appendChild (ol);
    }
  } // addCSSOMRuleObjectToList

  window.addIEStyleDeclarationObjectToList = function (objstyle, ol) {
    var showAll = $('show-all-props').checked;
    for (n in objstyle) {
      var v = objstyle[n];
      if ((showAll || (v && (v != "false" || n != "accelerator"))) &&
          n != 'cssText') {
        var cli = document.createElement ('li');
        var propNameCode = cli.appendChild (document.createElement ('code'));
        propNameCode.innerText = n;
        propNameCode.className = 'CSS-Property-Name';
        cli.appendChild (document.createTextNode (': '));
        var propValueCode = cli.appendChild (document.createElement ('code'));
        propValueCode.innerText = v;
        propValueCode.className = 'CSS-Property-Value';
        ol.appendChild (cli);
      }
    }
  }; // addIEStyleDeclarationObjectToList

  window.addCSSOMStyleDeclarationObjectToList = function (objstyle, ol) {
    for (var i = 0; i < objstyle.length; i++) {
      var propName = objstyle[i];
      var cli = document.createElement ('li');
      var propNameCode = cli.appendChild (document.createElement ('code'));
      propNameCode.textContent = propName;
      propNameCode.className = 'CSS-Property-Name';
      cli.appendChild (document.createTextNode (': '));
      var propValueCode = cli.appendChild (document.createElement ('code'));
      propValueCode.textContent = objstyle.getPropertyValue (propName);
      propValueCode.className = 'CSS-Property-Value';
      cli.appendChild (document.createTextNode (' !'));
      var propPriorityCode = cli.appendChild (document.createElement ('code'));
      propPriorityCode.textContent = objstyle.getPropertyPriority (propName);
      propPriorityCode.className = 'CSS-Property-Priority';
      ol.appendChild (cli);
    }
  }; // addCSSOMStyleDeclarationObjectToList
  
  window.toggleBoxDisplay = function (anchor, id) {
    var obj = document.getElementById (id);
    if (obj.style.display == 'none') {
      obj.style.display = 'block';
      anchor.innerHTML = 'Hide';
    } else {
      obj.style.display = 'none';
      anchor.innerHTML = 'Show';
    }
  }; // toggleBoxDisplay

  function record (s) {
    $('log').appendChild (document.createTextNode (s + "\r\n"));
  } // record
</script>
</head>
<body>
<h1>Live <abbr title="Cascading Style Sheets Object Model">CSSOM</abbr> 
Viewer</h1>

<h2>Style sheet to test (<a href="" rel=permalink id=permalink>permalink</a>,
<a href="javascript:"
    onclick="toggleBoxDisplay (this, 'source-code'); return false">hide</a>,
    <select id=parse-context onchange="sourceTextUpdated (true)">
    <option value=style-element selected>HTML &lt;style> element</option>
    <option value=style-attribute>HTML style="" attribute</option>
    </select>)</h2>
<p><textarea id="source-code" oninput="sourceTextUpdated ()" onkeypress="sourceTextUpdated ()"></textarea></p>

<h2><a href="data:," id=cssTreeLink><abbr title="Cascading Style Sheets Object Model">CSSOM</abbr> 
View</a> (<a href="javascript:"
    onclick="toggleBoxDisplay (this, 'parsed-tree'); return false">hide</a><span id="show-all-props-all">, <input type="checkbox" id="show-all-props" onclick="sourceTextUpdated (true)">
<label for="show-all-props">Show all properties</label></span>)</h2>
<ol id="parsed-tree"></ol>

<h2><a href="data:," id=cssTextLink><code>cssText</code> view</a> 
(<a href="javascript:"
    onclick="toggleBoxDisplay (this, 'parsed-code-parent'); return false">hide</a>)</h2>
<div id="parsed-code-parent"></div>

<h2>Rendered document view (<a href="javascript:"
    onclick="toggleBoxDisplay (this, 'style-frame'); return false">hide</a>,
<a href="data:," id=test-as-data>as <code>data:</code></a>,
<a href="about:" id=test-as-about>as <code>about:</code></a>,
<a href="javascript:" id=test-as-javascript>as <code>javascript:</code></a>)</h2>
<p><iframe id="style-frame" src="about:blank"></iframe></p>
<!-- Firefox 1.5 does not allow to access to <style>.sheet.cssRules
               in Document with javascript:, data:, or about: URI.
               (But it allows to access to <style>.innerHTML! How secure!) -->

<h2><abbr title="Hypertext Markup Language">HTML</abbr> fragment 
to test (<a href="javascript:"
    onclick="toggleBoxDisplay (this, 'html-source-code'); return false">hide</a>)</h2>
<p><textarea id="html-source-code" oninput="sourceTextUpdated ()" onkeypress="sourceTextUpdated ()"></textarea></p>

<p><input type=radio name=compatMode value="noQuirks" checked
    id=compatMode-no-quirks
    onchange="parseMode = value; sourceTextUpdated (true)"
    onclick=" onchange () ">
    <label for=compatMode-no-quirks>No quirks</label>
<input type=radio name=compatMode value="limitedQuirks"
    id=compatMode-limited-quirks
    onchange="parseMode = value; sourceTextUpdated (true)"
    onclick=" onchange () ">
    <label for=compatMode-limited-quirks>Limited quirks</label>
<input type=radio name=compatMode value="quirks"
    id=compatMode-quirks
    onchange="parseMode = value; sourceTextUpdated (true)"
    onclick=" onchange () ">
    <label for=compatMode-quirks>Quirks</label></p>

<h2>Log (<a href="javascript:"
    onclick="toggleBoxDisplay (this, 'log'); return false">hide</a>)</h2>
<pre id="log"></pre>
<p>This script puts a function <code>w (<var>s</var>)</code>into the global
scope of the test page, where <var>s</var> is a string to output to the
log.  Also, a file <a href=image><code>image</code></a> (a PNG image) 
is accessible in the current directory.</p>

<footer>
<p>See also <a href="http://suika.fam.cx/gate/2005/sw/Live%20CSSOM%20Viewer"
    rel=help>SuikaWiki:Live 
<abbr title="Cascading Style Sheets Object Model">CSSOM</abbr> Viewer</a>.</p>
</footer>

</body>
</html>
<!-- $Date: 2007/10/06 06:17:04 $ -->
<!--

Copyright 2007 Wakaba <w@suika.fam.cx>

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

-->
